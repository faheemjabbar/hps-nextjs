// Prisma schema for Hospital Management System (HMS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------- ENUMS ---------------------

enum UserRole {
  ADMIN
  DOCTOR
  RECEPTIONIST
  PATIENT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// --------------------- USER MODEL ---------------------

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  password       String        // Hashed password
  role           UserRole
  isActive       Boolean       @default(true)
  lastLogin      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Role-based relations (One-to-One)
  doctor         Doctor?
  patient        Patient?
  receptionist   Receptionist?
  admin          Admin?

  // Track who created appointments
  createdAppointments Appointment[] @relation("CreatedBy")

  // Password reset
  resetToken     String?       @unique
  resetTokenExpiry DateTime?

  @@index([email])
  @@index([role])
}

// --------------------- ADMIN MODEL ---------------------

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  fullName  String
  email     String   @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
}

// --------------------- DOCTOR MODEL ---------------------

model Doctor {
  id                String        @id @default(cuid())
  userId            String        @unique
  fullName          String
  registrationId    String        @unique  // Medical registration number
  email             String        @unique
  phone             String?
  specialization    String
  qualification     String?       // MBBS, MD, etc.
  experience        Int?          // Years of experience
  consultationFee   Int?        @default(0)
  bio               String?       @db.Text
  profileImage      String?
  gender            Gender?
  isAvailable       Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[] @relation("DoctorAppointments")
  availability      DoctorAvailability[]
  reviews           Review[]

  @@index([email])
  @@index([specialization])
  @@index([isAvailable])
}

// --------------------- DOCTOR AVAILABILITY MODEL ---------------------

model DoctorAvailability {
  id           String     @id @default(cuid())
  doctorId     String
  dayOfWeek    DayOfWeek
  startTime    String     // Format: "09:00"
  endTime      String     // Format: "17:00"
  slotDuration Int        @default(30)  // in minutes
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  doctor       Doctor     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
  @@index([doctorId])
}

// --------------------- PATIENT MODEL ---------------------

model Patient {
  id            String        @id @default(cuid())
  userId        String        @unique
  fullName      String
  email         String        @unique
  phone         String?
  dob           DateTime?
  gender        Gender?
  bloodGroup    BloodGroup?
  address       String?       @db.Text
  emergencyContact String?
  emergencyPhone   String?
  profileImage  String?
  medicalHistory String?      @db.Text  // Existing conditions, allergies
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments  Appointment[] @relation("PatientAppointments")
  medicalRecords MedicalRecord[] @relation("PatientRecords")
  invoices      Invoice[]     @relation("PatientInvoices")
  reviews       Review[]

  @@index([email])
  @@index([phone])
}

// --------------------- RECEPTIONIST MODEL ---------------------

model Receptionist {
  id        String   @id @default(cuid())
  userId    String   @unique
  employeeId String  @unique  // Employee ID for receptionist
  fullName  String
  email     String   @unique
  phone     String?
  shift     String?  // Morning, Evening, Night
  desk      String?  // OPD, Front Desk, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([employeeId])
}

// --------------------- APPOINTMENT MODEL ---------------------

model Appointment {
  id            String            @id @default(cuid())
  doctorId      String
  patientId     String
  createdById   String?           // User who created (receptionist or patient)
  appointmentDate DateTime         // Date and time of appointment
  duration      Int               @default(30)  // Duration in minutes
  status        AppointmentStatus @default(SCHEDULED)
  reasonForVisit String?          @db.Text
  notes         String?           @db.Text
  cancelReason  String?           @db.Text
  cancelledAt   DateTime?
  completedAt   DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  doctor        Doctor            @relation(fields: [doctorId], references: [id], name: "DoctorAppointments", onDelete: Cascade)
  patient       Patient           @relation(fields: [patientId], references: [id], name: "PatientAppointments", onDelete: Cascade)
  createdBy     User?             @relation(fields: [createdById], references: [id], name: "CreatedBy")

  medicalRecords MedicalRecord[]
  invoices      Invoice[]         @relation("AppointmentInvoices")
  prescriptions Prescription[]

  @@index([doctorId])
  @@index([patientId])
  @@index([appointmentDate])
  @@index([status])
  @@index([createdById])
}

// --------------------- MEDICAL RECORD MODEL ---------------------

model MedicalRecord {
  id            String       @id @default(cuid())
  appointmentId String
  patientId     String
  diagnosis     String?      @db.Text
  symptoms      String?      @db.Text
  treatment     String?      @db.Text
  notes         String?      @db.Text
  vitalSigns    Json?        // BP, temperature, pulse, etc.
  labTests      String?      @db.Text
  followUpDate  DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  appointment   Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient       Patient      @relation(fields: [patientId], references: [id], name: "PatientRecords", onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([createdAt])
}

// --------------------- PRESCRIPTION MODEL ---------------------

model Prescription {
  id            String       @id @default(cuid())
  appointmentId String
  medicines     Json         // Array of {name, dosage, frequency, duration}
  instructions  String?      @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  appointment   Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
}

// --------------------- INVOICE MODEL ---------------------

model Invoice {
  id              String        @id @default(cuid())
  appointmentId   String
  patientId       String
  amount          Float
  discount        Float         @default(0)
  tax             Float         @default(0)
  totalAmount     Float
  status          InvoiceStatus @default(PENDING)
  paymentMethod   String?       // Cash, Card, UPI, Insurance
  transactionId   String?
  notes           String?       @db.Text
  paidAt          DateTime?
  dueDate         DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  appointment     Appointment   @relation(fields: [appointmentId], references: [id], name: "AppointmentInvoices", onDelete: Cascade)
  patient         Patient       @relation(fields: [patientId], references: [id], name: "PatientInvoices", onDelete: Cascade)

  @@index([appointmentId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

// --------------------- REVIEW MODEL ---------------------

model Review {
  id          String   @id @default(cuid())
  doctorId    String
  patientId   String
  rating      Int      // 1-5
  comment     String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([doctorId, patientId])
  @@index([doctorId])
  @@index([patientId])
}

// --------------------- NOTIFICATION MODEL ---------------------

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String   // APPOINTMENT, REMINDER, SYSTEM
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// --------------------- AUDIT LOG MODEL (Optional) ---------------------

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // User, Appointment, etc.
  entityId  String
  changes   Json?    // Store what changed
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}